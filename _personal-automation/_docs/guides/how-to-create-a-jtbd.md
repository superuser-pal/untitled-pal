# How to Create a New Workflow

## Overview
Workflows are automated sequences that help users accomplish tasks within a domain. They define inputs, steps, and outputs in a structured way.

## Step 1: Create Workflow Directory

```bash
mkdir -p _personal-automation/[domain]/workflows/[workflow-name]/
```

## Step 2: Create workflow.yaml

Copy the template:
```bash
cp _personal-automation/_docs/templates/workflow-template.yaml _personal-automation/[domain]/workflows/[workflow-name]/workflow.yaml
```

Edit with your workflow details:

```yaml
name: workflow-name
description: What this workflow accomplishes
domain: domain-name
version: 1.0.0

variables:
  workflow_name: "workflow-name"
  output_file: "{domain_root}/output/{current_date}-[output-name].md"
  data_folder: "{domain_root}/data"

inputs:
  - name: input_1
    description: What is this input for?
    required: true
  - name: input_2
    description: What is this input for?
    required: false
    default: "default value"

outputs:
  - name: output_1
    path: "{output_file}"
    description: What gets generated
```

## Step 3: Create instructions.md

This file contains the step-by-step logic the workflow engine executes.

**Basic Structure:**
```markdown
# [Workflow Name] Instructions

## Pre-Flight Checklist
- [ ] Verify required data files exist
- [ ] Confirm user inputs are valid
- [ ] Check output directory is writable

## Execution Steps

### Step 1: Load Configuration
- Read domain config from {domain_root}/config.yaml
- Load workflow variables from workflow.yaml
- Verify all required inputs provided

### Step 2: Gather Data
- Read [data-file-1] from {data_folder}/[file].md
- Read [data-file-2] from {data_folder}/[file].md
- Parse and validate data

### Step 3: Process
- [Specific processing logic]
- [Apply rules and calculations]
- [Generate insights or recommendations]

### Step 4: Generate Output
- Use template from template.md (if exists)
- Fill in all sections with processed data
- Format according to domain standards

### Step 5: Save Output
- Write to {output_file}
- Confirm file created successfully
- Display success message with file path

## Error Handling
- If data file missing: [action to take]
- If validation fails: [action to take]
- If output cannot be written: [action to take]

## Success Criteria
- [ ] All required data processed
- [ ] Output file generated at correct path
- [ ] Output contains all expected sections
- [ ] User informed of completion
```

## Step 4: Create template.md (Optional)

If your workflow generates structured output, create a template:

```markdown
# [Output Title]

**Generated:** {current_date}
**Workflow:** {workflow_name}
**Domain:** {domain_name}

---

## Summary
[Summary content goes here]

## Section 1
[Section 1 content]

## Section 2
[Section 2 content]

## Next Steps
1. [Action item 1]
2. [Action item 2]
3. [Action item 3]

---

*Generated by {workflow_name} workflow*
```

## Step 5: Create checklist.md (Optional)

Pre-flight checks before workflow execution:

```markdown
# [Workflow Name] Checklist

Before running this workflow, ensure:

## Required Data
- [ ] {data_folder}/[required-file-1].md exists
- [ ] {data_folder}/[required-file-2].md exists
- [ ] Data files contain valid information

## Configuration
- [ ] Domain config.yaml is properly configured
- [ ] All required variables are defined
- [ ] Output directory exists and is writable

## User Inputs
- [ ] You have [input-1] ready
- [ ] You have [input-2] ready

## Prerequisites
- [ ] [Any other requirement]
- [ ] [Any other requirement]

Ready to proceed? ✅
```

## Step 6: Register the Workflow

Add to `_personal-automation/_config/workflow-manifest.csv`:

```csv
"workflow-name","Workflow description","domain-name","_personal-automation/[domain]/workflows/[workflow-name]/workflow.yaml"
```

Update domain agent menu (`_personal-automation/[domain]/agents/[agent].md`):

```xml
<menu>
  <!-- existing items -->
  <item cmd="*workflow-name" exec="{domain_root}/workflows/[workflow-name]/workflow.md">
    [Workflow Menu Description]
  </item>
  <!-- more items -->
</menu>
```

## Complete Example: Monthly Budget Workflow

### Directory Structure
```
finance/workflows/monthly-budget/
├── workflow.yaml
├── instructions.md
├── template.md
└── checklist.md
```

### workflow.yaml
```yaml
name: monthly-budget
description: Create comprehensive monthly budget based on income and expenses
domain: finance
version: 1.0.0

variables:
  workflow_name: "monthly-budget"
  output_file: "{domain_root}/output/{current_year}/{current_month}-budget.md"
  data_folder: "{domain_root}/data"
  income_file: "{data_folder}/income-sources.md"
  expenses_file: "{data_folder}/expense-categories.md"

inputs:
  - name: month
    description: Which month to budget for (YYYY-MM)
    required: true
  - name: special_expenses
    description: Any one-time expenses this month
    required: false
    default: "None"

outputs:
  - name: budget_document
    path: "{output_file}"
    description: Complete monthly budget with all categories and allocations
```

### instructions.md
```markdown
# Monthly Budget Creation Instructions

## Pre-Flight Checklist
- [ ] Verify income-sources.md exists in data folder
- [ ] Verify expense-categories.md exists in data folder
- [ ] Confirm month input is valid format (YYYY-MM)
- [ ] Check output directory exists

## Execution Steps

### Step 1: Load Financial Data
- Read {income_file} to get all income sources and amounts
- Read {expenses_file} to get all expense categories and historical averages
- Parse and validate all amounts are numbers

### Step 2: Calculate Total Income
- Sum all income sources from income-sources.md
- Account for any variable income adjustments
- Store as {total_income}

### Step 3: Process Expense Categories
- For each category in expense-categories.md:
  - Get historical average or fixed amount
  - Apply any seasonal adjustments for {month}
  - Mark as fixed or variable expense
- Calculate {total_planned_expenses}

### Step 4: Account for Special Expenses
- If {special_expenses} provided, parse and add to budget
- Categorize as one-time expenses
- Update {total_planned_expenses}

### Step 5: Calculate Budget Balance
- Remaining = {total_income} - {total_planned_expenses}
- If Remaining > 0: Allocate to savings/investment categories
- If Remaining < 0: Flag as deficit, suggest expense reductions
- Calculate savings rate percentage

### Step 6: Generate Recommendations
- Compare to previous months
- Identify highest expense categories
- Suggest optimization opportunities
- Highlight progress toward financial goals

### Step 7: Create Output
- Use template.md structure
- Fill in all calculated values
- Include all categories with allocated amounts
- Add recommendations section
- Format currency values

### Step 8: Save and Confirm
- Write to {output_file}
- Create year/month subdirectories if needed
- Display success message with file location
- Show quick summary (income, expenses, remaining)

## Error Handling
- If income-sources.md missing: Request user to create it first
- If expense-categories.md missing: Request user to create it first
- If month format invalid: Request correct format (YYYY-MM)
- If output directory not writable: Report error with path

## Success Criteria
- [ ] All income sources included
- [ ] All expense categories accounted for
- [ ] Budget balances (or deficit explained)
- [ ] Recommendations provided
- [ ] Output file created successfully
- [ ] User shown summary and next steps
```

### template.md
```markdown
# Monthly Budget - {month}

**Generated:** {current_date}
**Total Income:** ${total_income}
**Total Planned Expenses:** ${total_planned_expenses}
**Remaining:** ${remaining} ({savings_rate}% savings rate)

---

## Income Sources

| Source | Amount |
|--------|--------|
| {income_item_1} | ${amount_1} |
| {income_item_2} | ${amount_2} |
| **Total** | **${total_income}** |

---

## Fixed Expenses

| Category | Amount | Notes |
|----------|--------|-------|
| {fixed_expense_1} | ${amount} | {notes} |
| {fixed_expense_2} | ${amount} | {notes} |
| **Subtotal** | **${fixed_total}** | |

---

## Variable Expenses

| Category | Budgeted | Historical Avg | Notes |
|----------|----------|----------------|-------|
| {variable_expense_1} | ${budgeted} | ${average} | {notes} |
| {variable_expense_2} | ${budgeted} | ${average} | {notes} |
| **Subtotal** | **${variable_total}** | | |

---

## Special Expenses (This Month)

| Item | Amount | Category |
|------|--------|----------|
| {special_item_1} | ${amount} | {category} |
| **Subtotal** | **${special_total}** | |

---

## Savings & Investments

| Category | Amount | Percentage of Income |
|----------|--------|---------------------|
| {savings_category_1} | ${amount} | {percentage}% |
| {savings_category_2} | ${amount} | {percentage}% |
| **Subtotal** | **${savings_total}** | **{savings_rate}%** |

---

## Budget Summary

- **Total Income:** ${total_income}
- **Total Expenses:** ${total_expenses}
- **Remaining for Savings:** ${remaining}
- **Savings Rate:** {savings_rate}%

{deficit_warning_if_applicable}

---

## Insights & Recommendations

### Top Expense Categories
1. {category_1}: ${amount} ({percentage}% of income)
2. {category_2}: ${amount} ({percentage}% of income)
3. {category_3}: ${amount} ({percentage}% of income)

### Optimization Opportunities
- {recommendation_1}
- {recommendation_2}
- {recommendation_3}

### Comparison to Previous Month
- Income: {change_percentage}%
- Expenses: {change_percentage}%
- Savings Rate: {change_percentage} percentage points

---

## Next Steps

1. [ ] Review and approve this budget
2. [ ] Set up spending tracking for variable categories
3. [ ] Schedule mid-month budget check-in
4. [ ] Update expense categories if needed

---

*Generated by monthly-budget workflow | Finance Domain*
*Next Budget Due: {next_month}*
```

### checklist.md
```markdown
# Monthly Budget Checklist

Before running this workflow, ensure:

## Required Data Files
- [ ] `finance/data/income-sources.md` exists and is up to date
- [ ] `finance/data/expense-categories.md` exists and is up to date
- [ ] All income amounts are current
- [ ] Expense categories reflect your actual spending

## Configuration
- [ ] Domain config.yaml has correct currency setting
- [ ] Output directory `finance/output/{year}/` exists

## User Inputs Ready
- [ ] You know which month you're budgeting for (YYYY-MM format)
- [ ] You've identified any special one-time expenses for this month

## Optional Preparation
- [ ] Review last month's actual spending
- [ ] Note any upcoming irregular expenses
- [ ] Consider any income changes

Ready to create your budget? ✅
```

## Workflow Patterns

### Pattern 1: Data Collection Workflow
Gathers information from user and saves to data files.

**Use case:** Initial setup, updating personal information
**Example:** Setup income sources, Define expense categories

### Pattern 2: Analysis Workflow
Reads data files and generates insights.

**Use case:** Understanding patterns, Getting recommendations
**Example:** Spending analysis, Fitness progress review

### Pattern 3: Planning Workflow
Creates plans or schedules based on data and user goals.

**Use case:** Future planning, Resource allocation
**Example:** Monthly budget, Weekly meal plan, Trip itinerary

### Pattern 4: Tracking Workflow
Logs activities or events over time.

**Use case:** Ongoing monitoring, Habit formation
**Example:** Workout log, Expense tracking, Time logging

### Pattern 5: Review Workflow
Reflects on past period and identifies lessons.

**Use case:** Periodic assessment, Goal adjustment
**Example:** Monthly review, Quarterly reflection

## Tips for Great Workflows

### Keep Instructions Clear
✅ **Step-by-step**: Each step should be obvious
✅ **Specific**: "Read income-sources.md" not "get income data"
✅ **Complete**: Include all edge cases and errors

### Design Good Templates
✅ **Structured**: Clear sections and hierarchy
✅ **Actionable**: Include next steps
✅ **Consistent**: Match domain standards

### Handle Errors Gracefully
✅ **Validate inputs**: Check before processing
✅ **Friendly messages**: Help user fix the issue
✅ **Fail safely**: Don't corrupt data

### Make It Repeatable
✅ **Consistent output**: Same inputs → same output
✅ **Dated files**: Include date in filename
✅ **Organized storage**: Use year/month folders

## Common Mistakes to Avoid

❌ **Too many inputs**: Users get fatigued
✅ **2-5 inputs max**: Auto-load from data files when possible

❌ **Vague instructions**: "Process the data"
✅ **Specific steps**: "Calculate sum of all income sources from income-sources.md"

❌ **No error handling**: Workflow breaks on bad data
✅ **Validate everything**: Check files exist, data is valid

❌ **Hardcoded paths**: Won't work for other users
✅ **Use variables**: {domain_root}, {data_folder}, etc.

## Testing Your Workflow

1. **Test with minimal data**: Does it work with bare minimum?
2. **Test with full data**: Does it handle complex cases?
3. **Test error cases**: What happens when files are missing?
4. **Test output**: Is the generated file useful?
5. **Test repeatability**: Can you run it multiple times?

## Next Steps

After creating your workflow:
1. Add it to your domain agent's menu
2. Register it in workflow-manifest.csv
3. Test with real data
4. Iterate based on usage
5. Create related workflows that build on it
